<?xml version="1.0" encoding="UTF-8"?>
<project name="name-of-project" default="full-build">
 <!-- By default, we assume all tools to be on the $PATH -->
  <property name="phpcs" value="/root/.composer/vendor/bin/phpcs"/>

  <target name="full-build"
  depends="prepare,lint,phpcs,log"
  description="Performs static analysis, runs the tests, and generates project documentation"/>

  <target name="prepare"
  unless="prepare.done"
  description="Prepare for build">
    <delete dir="${basedir}/build/logs"/>
    <mkdir dir="${basedir}/build/logs"/>
    <property name="prepare.done" value="true"/>
  </target>

  <target name="lint"
  unless="lint.done"
  description="Perform syntax check of sourcecode files">
    <apply executable="php" output="${basedir}/build/logs/lint.log" taskname="lint" failonerror="true">
      <arg value="-l" />

      <fileset dir="${basedir}/docroot/modules/custom">
        <include name="**/*.php" />
        <include name="**/*.module" />
        <include name="**/*.inc" />
        <include name="**/*.install" />
        <include name="**/*.theme" />
        <modified />
      </fileset>
    </apply>

    <property name="lint.done" value="true"/>
  </target>

  <target name="phpcs"
  unless="phpcs.done"
  description="Find coding standard violations using PHP_CodeSniffer and print human readable output. Intended for usage on the command line before committing.">
    <exec executable="${phpcs}" output="${basedir}/build/logs/phpcs.log" taskname="phpcs" failonerror="true">
      <arg value="--standard=Drupal" />
      <arg value="--extensions=php,module,inc,install,test,profile,theme,js,css,info,txt" />
      <arg value="--ignore=autoload.php" />
      <arg path="${basedir}/docroot/modules/custom" />
    </exec>

    <property name="phpcs.done" value="true"/>
  </target>
  <target name="log"
  unless="log.done"
  description="Provide link to log files.">
    <echo><a href="${basedir}/build/logs/lint.log">Linter Log.</a></echo>
    <echo><a href="${basedir}/build/logs/phpcs.log">PHPCS Log.</a></echo>
    <property name="log.done" value="true"/>
  </target>
</project>
